pipeline {
    agent {
        docker {
            image 'mcr.microsoft.com/playwright:v1.52.0-noble'
            args '--network playwrigth-e2e-tests_skynet'
        }
    }

    options {
        timeout(time: 5, unit: 'MINUTES') // ⏱️ evita builds travados por muito tempo
    }

    stages {
        stage('Instalar dependências') {
            steps {
                sh 'npm ci' // ✅ Mais rápido e confiável que `npm install` em pipelines
            }
        }

        stage('Executar testes E2E') {
            steps {
                sh 'npx playwright test'
            }
        }

        stage('Debug (se falhar)') {
            when {
                expression { currentBuild.result == 'FAILURE' }
            }
            steps {
                sh 'ls -la && pwd && node -v && npm -v'
            }
        }
    }

    post {
        always {
            echo 'Finalizando pipeline'
        }
        success {
            echo '✅ Pipeline concluída com sucesso!'
        }
        failure {
            echo '❌ Falha na pipeline, revise os testes.'
        }
    }
}
